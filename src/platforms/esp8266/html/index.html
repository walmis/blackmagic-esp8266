<!doctype html>
  <html>
    <head>
      <link rel="stylesheet" href="xterm.css" />
      <script src="xterm.js"></script>
      <script src="xterm-addon-fit.js"></script>
    </head>
    <body>
      <div id="terminal" style="height: 90vh" ></div>
      <input type="text" id="line"></input>
      
      
      <script>
        var line_items = [];
        var idx = -1;
        
        document.querySelector("#line").addEventListener("keydown", event => {
            console.log(event.key)
            if(event.key == "ArrowUp") {
                if(idx < 0) return;
                console.log(idx)
                event.srcElement.value = line_items[idx--]
                
            }
            if(event.key == "ArrowDown") {
                if(idx == line_items.length) return;
                console.log(idx)
                event.srcElement.value = line_items[idx++]
            } 
            
            if(event.key !== "Enter") return; 
            console.log(event.srcElement.value)
            term.write(event.srcElement.value)
            if(! line_items.includes(event.srcElement.value)) {
                line_items.push(event.srcElement.value)
                idx++;
            }
            event.preventDefault(); // No need to `return false;`.
        });
        
        var term = new Terminal({cursorBlink: true, convertEol: true });
        var fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        
        var socket = new WebSocket("ws://192.168.4.1/terminal");
        socket.onopen = function(e) {
          term.write("\x1B[1;3;31m[Websocket] Connection established\x1B[0m\r\n");
        };

        socket.onmessage = function(event) {
            term.write(event.data);          
        };

        socket.onclose = function(event) {
          if (event.wasClean) {
            term.write("[Websocket] Connection closed");
          } else {
            // e.g. server process killed or network down
            // event.code is usually 1006 in this case
            term.write("[Websocket] Connection died");
          }
        };

        
        term.open(document.getElementById('terminal'));



        //term.write('Hello from \x1B[1;3;31mxterm.js\x1B[0m $ ')
        
        term.onData(chunk => {
            socket.send(chunk)
        })
        fitAddon.activate(term)
        fitAddon.fit()
        term.focus()
        
        window.addEventListener('resize', () => { fitAddon.fit() } );
        
      </script>
    </body>
  </html>
